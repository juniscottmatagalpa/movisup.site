<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sora2 Downloader</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    .container { max-width: 600px; margin: auto; }
    textarea { width: 100%; height: 60px; margin-bottom: 1rem; }
    button { padding: 0.5rem 1rem; margin-right: 0.5rem; }
    .hidden { display: none; }
    #status { margin: 1rem 0; font-weight: bold; }
    #video-result img { max-width: 100%; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <main class="container">
    <h1>Sora2 Downloader</h1>

    <textarea id="link-input" placeholder="Pega el enlace del video Sora..."></textarea>
    <button id="download-btn" disabled>Download</button>
    <button id="clear-btn" class="hidden">Clear</button>

    <div id="status" class="status"></div>

    <section id="video-result" class="hidden result">
      <img id="thumb">
      <p><strong>Prompt:</strong> <span id="prompt"></span></p>
      <p><strong>Resolución:</strong> <span id="res"></span></p>
      <button id="download-main">Descargar Procesado</button>
      <button id="download-nwm">Descargar Sin Marca</button>
    </section>
  </main>

  <script>
    const $ = id => document.getElementById(id);

    function showStatus(msg){ $("status").textContent = msg }

    async function download(){
      const url = $("link-input").value.trim();
      if(!url) return showStatus("Ingresa un enlace válido");

      showStatus("Procesando...");
      $("download-btn").disabled = true;

      try {
        const res = await fetch("/api/download", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url })
        });

        if (!res.ok) throw new Error("Error en la API: " + res.status);

        const json = await res.json();

        if(json.code !== 200){
          showStatus(json.message || "Error procesando el video");
          $("download-btn").disabled = false;
          return;
        }

        const v = json.data;

        $("thumb").src = v.thumbnail;
        $("prompt").textContent = v.prompt;
        $("res").textContent = `${v.width}x${v.height}`;

        $("download-main").onclick = () => window.open(v.video_url);
        $("download-nwm").onclick = () => window.open(v.no_watermark_url);

        $("video-result").classList.remove("hidden");
        showStatus("Listo!");
      } catch (err) {
        console.error(err);
        showStatus("Error: " + err.message);
      } finally {
        $("download-btn").disabled = false;
      }
    }

    $("link-input").oninput = () => {
      const has = $("link-input").value.trim().length > 0;
      $("download-btn").disabled = !has;
      $("clear-btn").classList.toggle("hidden", !has);
    };

    $("download-btn").onclick = download;
    $("clear-btn").onclick = () => { $("link-input").value = ""; };
  </script>
</body>
</html>
