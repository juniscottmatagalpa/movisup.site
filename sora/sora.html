<!doctype html>
if(!isValidUrl(input) && input.length<5) return showStatus('Please enter a valid Sora link or ID', 'error');
setLoading(true);
showStatus('Requesting server...', 'info');


try{
const resp = await fetch('/api/download', {
method:'POST', headers:{'Content-Type':'application/json'},
body: JSON.stringify({ video_url: input })
});
const data = await resp.json();
if(resp.ok && data.code===200){
showVideoResult(data.data);
showStatus('Ready', 'success');
} else {
showStatus(data?.message || 'Download failed. Check your link and try again.', 'error');
}
}catch(err){
console.error(err);
showStatus('Server error. Check console.', 'error');
} finally{ setLoading(false); }
}


function showVideoResult(o){
$('video-result-container').classList.remove('hidden');
$('video-thumbnail').src = o.image_url || '';
$('video-resolution').textContent = (o.video_width && o.video_height) ? `${o.video_width} Ã— ${o.video_height}` : '';
$('video-prompt').textContent = o.prompt || o.description || '-';
if(o.encoded_video_url) $('download-video-btn').dataset.encoded = o.encoded_video_url;
if(o.nowatermarked_video_url) $('download-no-watermark-btn').dataset.encoded = o.nowatermarked_video_url;
}


function downloadUrl(url){
if(!url) return showStatus('No download url', 'error');
const a=document.createElement('a'); a.href=url; a.download=`sora_${Date.now()}.mp4`; document.body.appendChild(a); a.click(); a.remove();
}


window.addEventListener('load', ()=>{
$('link-input').addEventListener('input', ()=>{
const has = $('link-input').value.trim().length>0;
$('download-btn').disabled = !has;
if(has) $('clear-btn').classList.remove('hidden'); else $('clear-btn').classList.add('hidden');
});


$('download-btn').addEventListener('click', startDownload);
$('clear-btn').addEventListener('click', ()=>{ $('link-input').value=''; $('download-btn').disabled=true; $('clear-btn').classList.add('hidden'); });


$('download-video-btn').addEventListener('click', ()=>{ downloadUrl($('download-video-btn').dataset.encoded || '')});
$('download-no-watermark-btn').addEventListener('click', ()=>{ downloadUrl($('download-no-watermark-btn').dataset.encoded || '')});
});
</script>
</body>
</html>
