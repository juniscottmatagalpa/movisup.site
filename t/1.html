<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Debug - Descargar TikTok</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:18px;color:#111}
    .container{max-width:920px;margin:0 auto}
    input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd}
    .row{display:flex;gap:8px;align-items:center;margin-top:10px}
    button{padding:8px 12px;border-radius:8px;border:0;background:#ff7b00;color:#fff;cursor:pointer}
    #loader{display:none;margin-top:8px}
    .result{display:none;margin-top:14px;padding:12px;border-radius:10px;background:#fafafa;border:1px solid #eee}
    .stats-row{display:flex;gap:14px;justify-content:space-around;padding:10px;background:#fff7ed;border-radius:8px;margin-bottom:10px}
    .thumbnail{width:100%;max-height:420px;object-fit:cover;border-radius:8px;background:#eee}
    .description{background:#f1f1f1;padding:12px;border-radius:8px;white-space:pre-wrap;margin-top:10px}
    .debug{margin-top:12px;padding:10px;background:#fff;border-radius:8px;border:1px dashed #ccc;max-height:320px;overflow:auto;font-size:13px}
    .hidden{display:none}
    .download-buttons{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .small{font-size:13px;color:#666}
    footer{margin-top:26px;color:#666;font-size:13px;text-align:center}
  </style>
</head>
<body>
  <div class="container">
    <h2>Diagn√≥stico - Obtener info TikTok</h2>

    <div class="row">
      <input id="videoUrl" type="text" placeholder="Pega aqu√≠ el enlace de TikTok (ej: https://www.tiktok.com/t/...)">
      <button id="btnGet">Obtener informaci√≥n</button>
    </div>

    <div id="loader">Cargando... (si tarda m√°s de 10s, la petici√≥n puede estar siendo bloqueada)</div>

    <div id="result" class="result">
      <div id="statsRow" class="stats-row hidden">
        <div>üëÅÔ∏è <b id="views">0</b></div>
        <div>‚ù§Ô∏è <b id="likes">0</b></div>
        <div>üí¨ <b id="comments">0</b></div>
        <div>üîÑ <b id="shares">0</b></div>
        <div>üìå <b id="saves">0</b></div>
      </div>

      <img id="thumb" class="thumbnail" src="" alt="Miniatura" />
      <h3 id="title"></h3>
      <div id="userInfo" class="small"></div>
      <div id="hashtags" class="small" style="margin-top:8px;color:#666"></div>
      <div id="description" class="description"></div>

      <div class="download-buttons">
        <button onclick="descargar('low')">üì• Baja calidad</button>
        <button onclick="descargar('high')">üìπ Alta calidad</button>
        <button onclick="descargar('audio')">üéµ Solo MP3</button>
      </div>
    </div>

    <h3 style="margin-top:18px">Panel debug</h3>
    <div id="debug" class="debug">Aqu√≠ ver√°s la respuesta cruda del Worker y errores.</div>

    <footer>
      Si no aparece nada en el panel debug: comprueba que la URL del Worker (<code id="workerUrl"></code>) es correcta y accesible desde tu hosting.
    </footer>
  </div>

  <script>
    const WORKER_API = "https://late-sun-ad47.juniscottmatagalpa.workers.dev";
    document.getElementById('workerUrl').textContent = WORKER_API;

    const btn = document.getElementById('btnGet');
    const loader = document.getElementById('loader');
    const debugEl = document.getElementById('debug');

    function showLoader(show){
      loader.style.display = show ? 'block' : 'none';
    }

    function showDebug(text){
      debugEl.textContent = text;
    }

    function appendDebug(text){
      debugEl.textContent = debugEl.textContent + "\n\n" + text;
      debugEl.scrollTop = debugEl.scrollHeight;
    }

    btn.addEventListener('click', obtenerInfo);

    async function obtenerInfo(){
      const urlInput = document.getElementById('videoUrl').value.trim();
      if(!urlInput) return alert('Ingresa un enlace de TikTok');

      // limpiar UI
      document.getElementById('result').style.display = 'none';
      document.getElementById('thumb').src = '';
      document.getElementById('title').textContent = '';
      document.getElementById('userInfo').innerHTML = '';
      document.getElementById('description').textContent = '';
      document.getElementById('hashtags').textContent = '';
      document.getElementById('statsRow').classList.add('hidden');

      showLoader(true);
      showDebug('Iniciando petici√≥n al Worker...');

      // timeout con AbortController (10s)
      const controller = new AbortController();
      const timeout = setTimeout(()=> controller.abort(), 10000);

      try {
        const params = new URLSearchParams();
        params.append('q', urlInput);

        const res = await fetch(WORKER_API, {
          method: 'POST',
          headers: {'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},
          body: params.toString(),
          signal: controller.signal,
        });

        clearTimeout(timeout);

        appendDebug(`HTTP ${res.status} ${res.statusText}`);
        // mostrar cabeceras m√°s relevantes
        const hdrs = {};
        res.headers.forEach((v,k)=> hdrs[k]=v);
        appendDebug('Headers recibidos: ' + JSON.stringify(hdrs, null, 2));

        const text = await res.text();
        appendDebug('Body (texto):\n' + text.slice(0, 2000));

        let data;
        try {
          data = JSON.parse(text);
        } catch (err) {
          appendDebug('ERROR: respuesta no es JSON o parse failed: ' + err.message);
          showLoader(false);
          alert('La respuesta del Worker no es JSON. Revisa el panel debug. (Puede ser que el Worker devuelva HTML/error)');
          return;
        }

        appendDebug('JSON parseado. Estructura ra√≠z keys: ' + Object.keys(data).join(', '));
        showLoader(false);

        if(data.error){
          appendDebug('Error en JSON: ' + (data.error));
          alert('‚ùå Error desde el Worker: ' + data.error);
          return;
        }

        // Normalizar objeto con datos de video (varios esquemas)
        let videoData = null;
        if (data.data) videoData = data.data;
        else if (data.item) videoData = data.item;
        else if (data.items && Array.isArray(data.items) && data.items.length) videoData = data.items[0];
        else videoData = data; // fallback

        appendDebug('videoData seleccionado keys: ' + (videoData ? Object.keys(videoData).join(', ') : 'null'));

        // title/desc
        const title = videoData.title || videoData.desc || videoData.description || (videoData.aweme && videoData.aweme.desc) || '';
        document.getElementById('title').textContent = title || 'Video sin t√≠tulo';

        // thumb
        const thumb = videoData.cover || videoData.thumbnail || videoData.video?.cover || (videoData.aweme && videoData.aweme.video && videoData.aweme.video.cover) || '';
        document.getElementById('thumb').src = thumb || '';

        // hashtags
        let hashtagsText = '';
        if(Array.isArray(videoData.hashtags)) hashtagsText = videoData.hashtags.map(h=>h.name||h).join(' ');
        else if(videoData.hashtag) hashtagsText = videoData.hashtag;
        else if(videoData.tags) hashtagsText = Array.isArray(videoData.tags) ? videoData.tags.join(' ') : (videoData.tags || '');
        document.getElementById('hashtags').textContent = hashtagsText;

        // description
        const description = videoData.desc || videoData.description || (videoData.aweme && videoData.aweme.desc) || '';
        if(description && description.trim().length){
          document.getElementById('description').textContent = description;
        } else {
          document.getElementById('description').textContent = '';
        }

        // author
        const author = videoData.author || videoData.owner || videoData.user || (videoData.aweme && videoData.aweme.author);
        if(author){
          const avatar = author.avatar || author.cover || author.avatar_thumb || author.profile_image || '';
          const name = author.unique_id || author.nickname || author.name || author.displayName || '';
          document.getElementById('userInfo').innerHTML = `<img src="${avatar||''}" style="width:36px;height:36px;border-radius:8px;object-fit:cover;margin-right:8px;vertical-align:middle"> <strong>${name || ''}</strong>`;
        }

        // stats: buscar en varios campos
        let stats = videoData.statistics || videoData.stat || videoData.stats || (videoData.aweme && videoData.aweme.statistics);
        if(!stats){
          const candidate = {};
          if(videoData.play_count) candidate.play_count = videoData.play_count;
          if(videoData.digg_count) candidate.digg_count = videoData.digg_count;
          if(videoData.comment_count) candidate.comment_count = videoData.comment_count;
          if(videoData.share_count) candidate.share_count = videoData.share_count;
          if(videoData.collect_count) candidate.collect_count = videoData.collect_count;
          stats = Object.keys(candidate).length ? candidate : null;
        }

        if(stats){
          document.getElementById('views').textContent = (stats.play_count || stats.playCount || stats.views || 0).toLocaleString();
          document.getElementById('likes').textContent = (stats.digg_count || stats.likeCount || stats.likes || 0).toLocaleString();
          document.getElementById('comments').textContent = (stats.comment_count || stats.commentCount || 0).toLocaleString();
          document.getElementById('shares').textContent = (stats.share_count || stats.shareCount || 0).toLocaleString();
          document.getElementById('saves').textContent = (stats.collect_count || stats.collection_count || stats.collectCount || 0).toLocaleString();
          document.getElementById('statsRow').classList.remove('hidden');
        } else {
          document.getElementById('statsRow').classList.add('hidden');
        }

        // show result
        document.getElementById('result').style.display = 'block';
        appendDebug('UI actualizada correctamente.');
      } catch (err){
        clearTimeout(timeout);
        showLoader(false);
        console.error('Error en fetch:', err);
        appendDebug('ERROR en fetch: ' + err.message);
        if(err.name === 'AbortError') alert('La petici√≥n tard√≥ demasiado y fue abortada (timeout). Puede haber bloqueo o latencia en el Worker.');
        else alert('Error al obtener la informaci√≥n. Revisa el panel debug.');
      }
    }

    // descargar: mantiene la l√≥gica de redirigir al worker ?download=...&ext=...
    async function descargar(quality){
      const urlInput = document.getElementById('videoUrl').value.trim();
      if(!urlInput) return alert('Primero ingresa un enlace.');

      showDebug('Obteniendo URLs para descarga...');
      try {
        const params = new URLSearchParams(); params.append('q', urlInput);
        const res = await fetch(WORKER_API, {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},
          body: params.toString()
        });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch(e) { showDebug('Respuesta no JSON: ' + text); alert('No se pudo obtener enlaces de descarga. Revisa debug.'); return; }

        if(!data || !data.data) { alert('No se encontr√≥ un enlace de descarga v√°lido.'); showDebug(JSON.stringify(data)); return; }

        const videoData = data.data;
        let downloadUrl = '';
        let ext = 'mp4';
        if(quality==='audio'){ downloadUrl = videoData.music || videoData.music_url || videoData.music_info?.play || videoData.play; ext='mp3'; }
        else if(quality==='low'){ downloadUrl = videoData.wmplay || videoData.play; }
        else{ downloadUrl = videoData.play || videoData.hdplay || videoData.wmplay; }

        if(!downloadUrl){ alert('No se encontr√≥ URL para esta calidad'); showDebug(JSON.stringify(videoData)); return; }

        // redirigir al worker para forzar descarga
        window.location.href = `${WORKER_API}?download=${encodeURIComponent(downloadUrl)}&ext=${encodeURIComponent(ext)}`;
      } catch(err){
        console.error('Error en descargar():', err);
        showDebug('Error en descargar(): ' + err.message);
        alert('Error al preparar la descarga. Revisa panel debug.');
      }
    }
  </script>
</body>
</html>

