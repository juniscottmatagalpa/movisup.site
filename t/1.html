<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Descargar videos de TikTok sin marca de agua HD</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      margin: 0;
      padding: 20px;
      background: #ffefd5; /* naranja claro */
      color: #111;
      display: flex;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 480px;
      background: #fff;
      padding: 22px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      font-size: 1.4rem;
      color: #222;
      font-weight: 600;
      margin-bottom: 20px;
    }
    .input-group {
      display: flex;
      align-items: center;
      border: 2px solid #32cd32;
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }
    #videoUrl {
      flex: 1;
      border: none;
      padding: 12px;
      font-size: 15px;
      outline: none;
    }
    #pasteClearBtn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 10px;
      width: 42px;
      height: 42px;
    }
    #pasteClearBtn img {
      width: 24px;
      height: 24px;
    }
    #btnGet {
      width: 100%;
      margin-top: 14px;
      padding: 12px;
      background: #ff7b00;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #btnGet:active {
      transform: scale(0.97);
    }
    #loader {
      display: none;
      margin-top: 10px;
      text-align: center;
      color: #666;
    }
    .result {
      display: none;
      margin-top: 16px;
      padding: 12px;
      border-radius: 10px;
      background: #fafafa;
      border: 1px solid #eee;
    }
    .stats-row {
      display: flex;
      gap: 14px;
      justify-content: space-around;
      padding: 10px;
      background: #fff7ed;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .thumbnail {
      width: 100%;
      max-height: 420px;
      object-fit: cover;
      border-radius: 8px;
      background: #eee;
    }
    .description {
      background: #f1f1f1;
      padding: 12px;
      border-radius: 8px;
      white-space: pre-wrap;
      margin-top: 10px;
    }
    .download-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .download-buttons button {
      flex: 1;
      background: #ff7b00;
      border: none;
      color: #fff;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
    }
    .hidden { display:none }
    @media (max-width: 480px) {
      .container { padding: 16px; }
      h2 { font-size: 1.2rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Descargar videos de TikTok sin marca de agua HD</h2>

    <div class="input-group">
      <input id="videoUrl" type="text" placeholder="Pega aqu√≠ el enlace de TikTok">
      <button id="pasteClearBtn"><img src="img/pegar.png" alt="pegar"></button>
    </div>

    <button id="btnGet">Obtener informaci√≥n</button>

    <div id="loader">Cargando...</div>

    <div id="result" class="result">
      <div id="statsRow" class="stats-row hidden">
        <div>üëÅÔ∏è <b id="views">0</b></div>
        <div>‚ù§Ô∏è <b id="likes">0</b></div>
        <div>üí¨ <b id="comments">0</b></div>
        <div>üîÑ <b id="shares">0</b></div>
        <div>üìå <b id="saves">0</b></div>
      </div>

      <img id="thumb" class="thumbnail" src="" alt="Miniatura" />
      <h3 id="title"></h3>
      <div id="userInfo" class="small"></div>
      <div id="hashtags" class="small" style="margin-top:8px;color:#666"></div>
      <div id="description" class="description"></div>

      <div class="download-buttons">
        <button onclick="descargar('low')">üì• Baja calidad</button>
        <button onclick="descargar('high')">üìπ Alta calidad</button>
        <button onclick="descargar('audio')">üéµ Solo MP3</button>
      </div>
    </div>
  </div>

  <script>
    const WORKER_API = "https://late-sun-ad47.juniscottmatagalpa.workers.dev";
    const btn = document.getElementById('btnGet');
    const loader = document.getElementById('loader');
    const videoUrlInput = document.getElementById('videoUrl');
    const pasteClearBtn = document.getElementById('pasteClearBtn');

    function validarTikTok(url) {
      return /tiktok\.com|vm\.tiktok\.com|vt\.tiktok\.com/i.test(url);
    }

    pasteClearBtn.addEventListener('click', async () => {
      if (videoUrlInput.value.trim() !== "") {
        videoUrlInput.value = "";
        pasteClearBtn.innerHTML = '<img src="img/pegar.png" alt="pegar">';
        return;
      }
      try {
        const text = await navigator.clipboard.readText();
        if (validarTikTok(text)) {
          videoUrlInput.value = text;
          pasteClearBtn.innerHTML = '<img src="img/borrar.png" alt="borrar">';
          obtenerInfo();
        } else {
          alert("El texto copiado no es un enlace v√°lido de TikTok.");
        }
      } catch {
        alert("No se pudo acceder al portapapeles.");
      }
    });

    videoUrlInput.addEventListener("input", () => {
      pasteClearBtn.innerHTML = videoUrlInput.value.trim()
        ? '<img src="img/borrar.png" alt="borrar">'
        : '<img src="img/pegar.png" alt="pegar">';
    });

    function showLoader(show){ loader.style.display = show ? 'block' : 'none'; }

    btn.addEventListener('click', () => {
      const url = videoUrlInput.value.trim();
      if (!url || !validarTikTok(url)) return alert('Ingresa un enlace v√°lido de TikTok');
      obtenerInfo();
    });

    async function obtenerInfo(){
      const urlInput = videoUrlInput.value.trim();
      if(!urlInput) return alert('Ingresa un enlace de TikTok');

      document.getElementById('result').style.display = 'none';
      document.getElementById('thumb').src = '';
      document.getElementById('title').textContent = '';
      document.getElementById('userInfo').innerHTML = '';
      document.getElementById('description').textContent = '';
      document.getElementById('hashtags').textContent = '';
      document.getElementById('statsRow').classList.add('hidden');

      showLoader(true);

      const controller = new AbortController();
      const timeout = setTimeout(()=> controller.abort(), 10000);

      try {
        const params = new URLSearchParams();
        params.append('q', urlInput);

        const res = await fetch(WORKER_API, {
          method: 'POST',
          headers: {'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},
          body: params.toString(),
          signal: controller.signal,
        });

        clearTimeout(timeout);
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { showLoader(false); alert('Error: respuesta no v√°lida.'); return; }

        showLoader(false);
        if(data.error){ alert('‚ùå Error: ' + data.error); return; }

        // --- L√ìGICA ORIGINAL DE DATOS ---
        let videoData = null;
        if (data.data) videoData = data.data;
        else if (data.item) videoData = data.item;
        else if (data.items && Array.isArray(data.items) && data.items.length) videoData = data.items[0];
        else videoData = data;

        const title = videoData.title || videoData.desc || videoData.description || '';
        document.getElementById('title').textContent = title || 'Video sin t√≠tulo';

        const thumb = videoData.cover || videoData.thumbnail || videoData.video?.cover || '';
        document.getElementById('thumb').src = thumb || '';

        let hashtagsText = '';
        if(Array.isArray(videoData.hashtags)) hashtagsText = videoData.hashtags.map(h=>h.name||h).join(' ');
        else if(videoData.hashtag) hashtagsText = videoData.hashtag;
        else if(videoData.tags) hashtagsText = Array.isArray(videoData.tags) ? videoData.tags.join(' ') : (videoData.tags || '');
        document.getElementById('hashtags').textContent = hashtagsText;

        const description = videoData.desc || videoData.description || '';
        document.getElementById('description').textContent = description;

        const author = videoData.author || videoData.owner || videoData.user;
        if(author){
          const avatar = author.avatar || author.cover || author.avatar_thumb || author.profile_image || '';
          const name = author.unique_id || author.nickname || author.name || author.displayName || '';
          document.getElementById('userInfo').innerHTML = `<img src="${avatar||''}" style="width:36px;height:36px;border-radius:8px;object-fit:cover;margin-right:8px;vertical-align:middle"> <strong>${name || ''}</strong>`;
        }

        // ‚úÖ Recupera correctamente las estad√≠sticas
        let stats = videoData.statistics || videoData.stat || videoData.stats || (videoData.aweme && videoData.aweme.statistics);
        if(!stats){
          const candidate = {};
          if(videoData.play_count) candidate.play_count = videoData.play_count;
          if(videoData.digg_count) candidate.digg_count = videoData.digg_count;
          if(videoData.comment_count) candidate.comment_count = videoData.comment_count;
          if(videoData.share_count) candidate.share_count = videoData.share_count;
          if(videoData.collect_count) candidate.collect_count = videoData.collect_count;
          stats = Object.keys(candidate).length ? candidate : null;
        }

        if(stats){
          document.getElementById('views').textContent = (stats.play_count || stats.playCount || stats.views || 0).toLocaleString();
          document.getElementById('likes').textContent = (stats.digg_count || stats.likeCount || stats.likes || 0).toLocaleString();
          document.getElementById('comments').textContent = (stats.comment_count || stats.commentCount || 0).toLocaleString();
          document.getElementById('shares').textContent = (stats.share_count || stats.shareCount || 0).toLocaleString();
          document.getElementById('saves').textContent = (stats.collect_count || stats.collection_count || stats.collectCount || 0).toLocaleString();
          document.getElementById('statsRow').classList.remove('hidden');
        }

        document.getElementById('result').style.display = 'block';
      } catch (err){
        clearTimeout(timeout);
        showLoader(false);
        alert('Error al obtener la informaci√≥n.');
      }
    }

    async function descargar(quality){
      const urlInput = videoUrlInput.value.trim();
      if(!urlInput) return alert('Primero ingresa un enlace.');
      try {
        const params = new URLSearchParams(); params.append('q', urlInput);
        const res = await fetch(WORKER_API, {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},
          body: params.toString()
        });
        const text = await res.text();
        const data = JSON.parse(text);
        if(!data || !data.data){ alert('No se encontr√≥ enlace de descarga.'); return; }

        const videoData = data.data;
        let downloadUrl = '';
        let ext = 'mp4';
        if(quality==='audio'){ downloadUrl = videoData.music || videoData.music_url; ext='mp3'; }
        else if(quality==='low'){ downloadUrl = videoData.wmplay || videoData.play; }
        else{ downloadUrl = videoData.play || videoData.hdplay || videoData.wmplay; }

        if(!downloadUrl){ alert('No se encontr√≥ URL v√°lida.'); return; }

        window.location.href = `${WORKER_API}?download=${encodeURIComponent(downloadUrl)}&ext=${encodeURIComponent(ext)}`;
      } catch(err){
        alert('Error al preparar la descarga.');
      }
    }
  </script>
</body>
</html>






